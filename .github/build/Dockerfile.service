## BUILDER
FROM kodmain/os:alpine AS builder

ARG BINARY_VERSION=latest
ENV BINARY_VERSION=${BINARY_VERSION}
USER root:root

RUN ARCHITECTURE=$(uname -m) && if [ "$ARCHITECTURE" = "aarch64" ] || [ "$ARCHITECTURE" = "arm64" ]; then \
      curl -L -o /bin/kitsune https://github.com/kodmain/kitsune/releases/download/${BINARY_VERSION}/kitsune-linux-arm64; \
    else \
      curl -L -o /bin/kitsune https://github.com/kodmain/kitsune/releases/download/${BINARY_VERSION}/kitsune-linux-amd64; \
    fi;

RUN chmod +x /bin/kitsune
RUN /bin/kitsune install

## RUNNER
FROM alpine AS runner
COPY --from=builder /bin/kitsune /bin/kitsune
COPY --from=builder /etc/kitsune /etc/kitsune
RUN $(uname -m) > /etc/kitsune/arch; \
WORKDIR /run
ENTRYPOINT [ "/etc/kitsune/gateway" ]
#CMD [ "services", "start"]